-- RFM Segmentation
-- Recency, Frequency, Monetary analysis for customer segmentation

WITH rfm_base AS (
  SELECT
    customer_id,
    MAX(invoice_date) AS last_purchase,
    COUNT(DISTINCT invoice_no) AS frequency,
    SUM(quantity * unit_price) AS monetary
  FROM clean_orders
  GROUP BY customer_id
),
rfm_scores AS (
  SELECT
    customer_id,
    DATEDIFF(
      (SELECT MAX(invoice_date) FROM clean_orders),
      last_purchase
    ) AS recency_days,
    frequency,
    monetary,
    NTILE(5) OVER (ORDER BY DATEDIFF(
      (SELECT MAX(invoice_date) FROM clean_orders),
      last_purchase
    )) AS recency_rank,
    NTILE(5) OVER (ORDER BY frequency DESC) AS frequency_rank,
    NTILE(5) OVER (ORDER BY monetary DESC) AS monetary_rank
  FROM rfm_base
)
SELECT
  CASE
    WHEN recency_rank <= 2 AND frequency_rank >= 4 AND monetary_rank >= 4 THEN 'VIP'
    WHEN recency_rank <= 2 AND frequency_rank >= 4 THEN 'Loyal'
    WHEN recency_rank >= 4 AND frequency_rank >= 3 THEN 'At-Risk'
    ELSE 'Other'
  END AS segment,
  COUNT(*) AS customers,
  ROUND(SUM(monetary), 2) AS total_revenue
FROM rfm_scores
GROUP BY segment
ORDER BY total_revenue DESC;
