-- Cohort-based Lifetime Value (LTV)
-- Cumulative revenue per customer over time

SELECT
  cohort_month,
  months_since_acq,
  ROUND(
    AVG(
      SUM(revenue) OVER (
        PARTITION BY cohort_month, customer_id
        ORDER BY months_since_acq
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      )
    ),
    2
  ) AS avg_ltv
FROM orders_with_cohort
GROUP BY cohort_month, months_since_acq
ORDER BY cohort_month, months_since_acq;
